{"version":3,"sources":["questions.js"],"names":["models","Question","upload","dest","fileSizeLimit","renameFile","tempPath","targetPath","fs","rename","err","deleteFile","unlink","fileTypeHandleError","res","status","json","message","error","fileSizeHandleError","fileFilterMethod","req","fileErrorArray","fileSizeError","fileTypeError","filePath","file","path","Date","toISOString","originalname","mimetype","size","substring","length","authMethod","authMethodArray","noTokenProviderError","failedAuth","decodedID","token","body","query","headers","jwt","verify","app","get","decoded","id","questionsController","single","create","authValues","failedAuthError","decodedIDFromMethod","send","auth","title","question","tags","data","userId","questionImage","findAll","then","results","questions","rows","questionCount","result","catch","e","name","constraint","list"],"mappings":"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","file":"questions.js","sourceRoot":"/home/somto/1Projects/mentorship project/StackOverflow-lite/server/server/controllers","sourcesContent":["/*  eslint import/no-cycle: [2, { maxDepth: 1 }]  */\n/* eslint-disable no-restricted-syntax */\nimport multer from 'multer';\nimport fs from 'file-system';\nimport jwt from 'jsonwebtoken';\nimport models from '../models';\nimport app from '../../app';\n\nconst [Question] = [models.Question];\n\nconst upload = multer({\n  dest: './questionsUploads/'\n});\n\nconst fileSizeLimit = 1024 * 1024 * 2;\n\n/**\n * rename file to an appropriate name\n * @param {String} tempPath The temporary path name.\n * @param {String} targetPath The target path name.\n * @returns {void} nothing.\n */\nconst renameFile = (tempPath, targetPath) => {\n  fs.rename(tempPath, targetPath, (err) => {\n    if (err) throw err;\n  });\n};\n\n/**\n * delete a file\n * @param {String} targetPath The part to delete from\n * @returns {void} nothing.\n */\nconst deleteFile = (targetPath) => {\n  fs.unlink(targetPath, (err) => {\n    if (err) throw err;\n  });\n};\n\n// file type handleError\nconst fileTypeHandleError = (res) => {\n  res.status(403).json({ message: 'Only .png and .jpg files are allowed!', error: true });\n};\n\n// file size handleError\nconst fileSizeHandleError = (res) => {\n  res.status(403).json({ message: 'file should not be more than 2mb!', error: true });\n};\n\n/* File filter handle method */\nconst fileFilterMethod = (req) => {\n  const fileErrorArray = [];\n  let fileSizeError = false, fileTypeError = false, filePath = '';\n\n  if (req.file) {\n    const tempPath = `./${req.file.path}`;\n    const targetPath = `./questionsUploads/${new Date().toISOString() + req.file.originalname}`;\n    if (req.file.mimetype === 'image/jpeg' || req.file.mimetype === 'image/png') {\n      if (req.file.size <= fileSizeLimit) {\n        renameFile(tempPath, targetPath);\n        // remove the dot in targetPath\n        filePath = targetPath.substring(1, targetPath.length);\n      } else { deleteFile(tempPath); fileSizeError = true; }\n    } else { deleteFile(tempPath); fileTypeError = true; }\n  }\n  fileErrorArray[0] = fileSizeError; fileErrorArray[1] = fileTypeError;\n  fileErrorArray[2] = filePath;\n\n  return fileErrorArray;\n};\n\n/* Authentication handle method */\nconst authMethod = (req) => {\n  const authMethodArray = [];\n  let noTokenProviderError = false;\n  let failedAuth = false;\n  let decodedID;\n\n  // check header or url parameters or post parameters for token\n  const token = req.body.token || req.query.token || req.headers['x-access-token'];\n  if (!token) {\n    if (req.file) deleteFile(`./${req.file.path}`);\n    noTokenProviderError = true;\n  }\n\n  // verifies secret and checks exp\n  jwt.verify(token, app.get('superSecret'), (err, decoded) => {\n    if (err) {\n      if (!noTokenProviderError) {\n        if (req.file) deleteFile(`./${req.file.path}`);\n        failedAuth = true;\n      }\n    } else decodedID = decoded.id;\n  });\n\n  authMethodArray[0] = noTokenProviderError;\n  authMethodArray[1] = failedAuth;\n  authMethodArray[2] = decodedID;\n\n  return authMethodArray;\n};\n\nconst questionsController = {\n  upload: upload.single('questionImage'), // image upload\n  create(req, res) { // create a user\n    let decodedID;\n    const authValues = authMethod(req, res);\n    const noTokenProviderError = authValues[0];\n    const failedAuthError = authValues[1];\n    const decodedIDFromMethod = authValues[2];\n\n    if (noTokenProviderError) return res.status(401).send({ auth: false, message: 'No token provided.' });\n\n    if (failedAuthError) return res.status(500).send({ auth: false, message: 'Failed to authenticate token.' });\n\n    if (decodedIDFromMethod) decodedID = decodedIDFromMethod;\n\n    // implementing the file filter method\n    const [fileSizeError, fileTypeError, filePath] = fileFilterMethod(req);\n    if (fileSizeError) return fileSizeHandleError(res);\n    if (fileTypeError) return fileTypeHandleError(res);\n\n    /* Required feilds */\n    if (!req.body.title || !req.body.question || !req.body.tags) {\n      if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n      return res.status(206).send({ message: 'Incomplete field' });\n    }\n\n    // Grab data from http request\n    const data = {\n      title: req.body.title,\n      question: req.body.question,\n      userId: decodedID,\n      tags: req.body.tags,\n      questionImage: filePath,\n    };\n\n    /* Search to see if question title exist before creation\n    to avoid skipping of id on unique constraint */\n    Question.findAll().then((results) => {\n      const questions = results.rows; let questionCount = 0;\n      for (const question of questions) {\n        if (data.title === question.title) {\n          if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n          return res.status(400).send({ message: 'question already exists' });\n        }\n        questionCount += 1;\n      }\n      if (questionCount === questions.length) { // Create question after checking if it exist\n        Question.create(data) // pass data to our model\n          .then((result) => {\n            const question = result.rows[0];\n            return res.status(201).send(question);\n          }).catch((e) => {\n            if (e.name === 'error' && e.constraint === 'questions_userid_fkey') {\n              return res.status(400).send({ message: 'user has been removed from the database.' });\n            }\n            return res.status(200).send(e);\n          });\n      }\n    }).catch(e => res.status(400).send(e));\n  },\n  list(req, res) {\n    Question.findAll().then((results) => {\n      const questions = results.rows;\n      return res.status(200).send(questions)\n    }).catch(e => res.status(400).send(e));\n  },\n};\n\nexport default questionsController;\n"]}
{"version":3,"sources":["users.js"],"names":["models","User","renameFile","fsHelper","deleteFile","upload","dest","fileSizeLimit","fileTypeHandleError","res","status","json","message","error","fileSizeHandleError","usernameHandlerError","filePath","send","emailHandlerError","phoneHandlerError","tokenMethod","userId","token","jwt","sign","id","app","get","expiresIn","fileFilterMethod","req","fileErrorArray","fileSizeError","fileTypeError","file","tempPath","path","targetPath","Date","toISOString","originalname","mimetype","size","substring","length","usersController","single","create","body","username","password","email","gender","hashedPassword","bcrypt","hashSync","data","title","firstname","lastname","country","phone","userImage","findAll","then","results","users","rows","userCount","user","result","auth","catch","e","check","findOne","where","passIsEqual","compareSync"],"mappings":"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","file":"users.js","sourceRoot":"/home/somto/1Projects/mentorship project/StackOverflow-lite/server/server/controllers","sourcesContent":["/*  eslint import/no-cycle: [2, { maxDepth: 1 }]  */\n/* eslint-disable no-restricted-syntax */\nimport multer from 'multer';\nimport jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\nimport models from '../models';\nimport app from '../../app';\nimport fsHelper from '../../utilities/fileSystem';\n\nconst [User] = [models.User];\nconst renameFile = fsHelper.renameFile;//Rename file helper method\nconst deleteFile = fsHelper.deleteFile;//Delete file helper method\n\nconst upload = multer({\n  dest: './usersUploads/'\n});\n\nconst fileSizeLimit = 1024 * 1024 * 2;\n\n// file type handleError\nconst fileTypeHandleError = (res) => {\n  res.status(403).json({ message: 'Only .png and .jpg files are allowed!', error: true });\n};\n\n// file size handleError\nconst fileSizeHandleError = (res) => {\n  res.status(403).json({ message: 'file should not be more than 2mb!', error: true });\n};\n\nconst usernameHandlerError = (res, filePath) => {\n  if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n  return res.status(400).send({ message: 'username already exists' });\n}\n\nconst emailHandlerError = (res, filePath) => {\n  if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n  return res.status(400).send({ message: 'email already exists' });\n}\n\nconst phoneHandlerError = (res, filePath) => {\n  if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n  return res.status(400).send({ message: 'phone already exists' });\n}\n\n// Token creation hanlder method\nconst tokenMethod = (userId) => {\n  const token = jwt.sign(\n    { id: userId }, app.get('superSecret'),\n    { expiresIn: 86400 }// expires in 24 hours\n  );\n  return token;\n};\n\n/* File filter handle method */\nconst fileFilterMethod = (req) => {\n  const fileErrorArray = [];\n  let fileSizeError = false, fileTypeError = false, filePath = '';\n\n  if (req.file) {\n    const tempPath = `./${req.file.path}`;\n    const targetPath = `./usersUploads/${new Date().toISOString() + req.file.originalname}`;\n    if (req.file.mimetype === 'image/jpeg' || req.file.mimetype === 'image/png') {\n      if (req.file.size <= fileSizeLimit) {\n        renameFile(tempPath, targetPath);\n        // remove the dot in targetPath\n        filePath = targetPath.substring(1, targetPath.length);\n      } else { deleteFile(tempPath); fileSizeError = true; }\n    } else { deleteFile(tempPath); fileTypeError = true; }\n  }\n  fileErrorArray[0] = fileSizeError; fileErrorArray[1] = fileTypeError;\n  fileErrorArray[2] = filePath;\n\n  return fileErrorArray;\n};\n\n\nconst usersController = {\n  upload: upload.single('userImage'), // image upload\n  create(req, res) { // create a user\n    // implementing the file filter method\n    const [fileSizeError, fileTypeError, filePath] = fileFilterMethod(req);\n    if (fileSizeError) return fileSizeHandleError(res);\n    if (fileTypeError) return fileTypeHandleError(res);\n    /* Required feilds */\n    if (!req.body.username || !req.body.password || !req.body.email || !req.body.gender) {\n      if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n      return res.status(206).send({ message: 'Incomplete field' });\n    }\n    // Auto-gen a salt and hash\n    const hashedPassword = bcrypt.hashSync(req.body.password, 8);\n    // Grab data from http request\n    const data = {\n      title: req.body.title,\n      firstname: req.body.firstname,\n      lastname: req.body.lastname,\n      username: req.body.username,\n      password: hashedPassword,\n      email: req.body.email,\n      gender: req.body.gender,\n      country: req.body.country,\n      phone: req.body.phone,\n      userImage: filePath\n    };\n    /* Search to see if username, email and phone exist before creation\n    to avoid skipping of id on unique constraint */\n    User.findAll().then((results) => {\n      const users = results.rows; let userCount = 0;\n      for (const user of users) {\n        if (data.username === user.username) {\n          return usernameHandlerError(res, filePath);\n          // if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n          // return res.status(400).send({ message: 'username already exists' });\n        }\n        if (data.email === user.email) {\n          return emailHandlerError(res, filePath);\n          // if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n          // return res.status(400).send({ message: 'email already exists' });\n        }\n        if (data.phone === user.phone) {\n          return phoneHandlerError(res, filePath);\n          // if (filePath) deleteFile(`./${filePath}`); // if file uploads delete it\n          // return res.status(400).send({ message: 'phone already exists' });\n        }\n        userCount += 1;\n      }\n      if (userCount === users.length) { // Create user after checking if it exist\n        User.create(data) // pass data to our model\n          .then((result) => {\n            const user = result.rows[0];\n            const token = tokenMethod(user.id); // Generate token\n            if (token) return res.status(201).send({ user, auth: true, token });\n          }).catch(e => res.status(400).send(e));\n      }\n    }).catch(e => res.status(400).send(e));\n  },\n  check(req, res) { // login with username and password\n    // pass data to our model\n    User.findOne({ where: { username: req.body.username } })\n      .then((result) => {\n        const user = result.rows[0];\n        // Returning error message for user not found\n        if (!user) return res.status(400).send({ message: 'Invalid username/password' });\n        // Compare hash from your password DB.\n        const passIsEqual = bcrypt.compareSync(req.body.password, user.password);\n        if (!passIsEqual) return res.status(404).send({ message: 'Invalid username/password' });\n        const token = tokenMethod(user.id); // Generate token\n        // Returning user detais\n        if (token) return res.status(200).send({ user, auth: true, token });\n      }).catch(e => res.status(400).send(e));\n  },\n};\n\nexport default usersController;\n"]}
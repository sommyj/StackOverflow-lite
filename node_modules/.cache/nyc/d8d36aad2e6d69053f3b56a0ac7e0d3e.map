{"version":3,"sources":["users.js"],"names":["models","User","imageStorage","uploadImageToStorage","errorHandler","createHandlerError","incompleteFieldHandlerError","fileHandleError","usernameHandlerError","emailHandlerError","phoneHandlerError","upload","storage","multer","memoryStorage","fileSizeLimit","tokenMethod","userId","token","jwt","sign","id","app","get","expiresIn","usersController","single","create","req","res","body","username","password","email","gender","hashedPassword","bcrypt","hashSync","file","fileName","findAll","then","results","users","rows","userCount","user","phone","length","fileError","status","send","data","title","firstname","lastname","country","userImage","result","auth","catch","error","check","findOne","where","message","passIsEqual","compareSync","e"],"mappings":";;;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;2cATA;AACA;;;WAUe,CAACA,iBAAOC,IAAR,C;IAARA,I;YACwB,CAACC,0BAAaC,oBAAd,C;IAAxBA,oB;YACsB,CAACC,uBAAaC,kBAAd,C;IAAtBA,kB,aAAyD;AAChE;;YACsC,CAACD,uBAAaE,2BAAd,C;IAA/BA,2B;YACmB,CAACF,uBAAaG,eAAd,C;IAAnBA,e,aAAmD;;YAC3B,CAACH,uBAAaI,oBAAd,C;IAAxBA,oB,aAA6D;;YACxC,CAACJ,uBAAaK,iBAAd,C;IAArBA,iB,aAAuD;;YAClC,CAACL,uBAAaM,iBAAd,C;IAArBA,iB,aAAuD;;AAE9D,IAAMC,SAAS,sBAAO;AACpBC,WAASC,iBAAOC,aAAP;AADW,CAAP,CAAf;;AAIA,IAAMC,gBAAgB,OAAO,IAAP,GAAc,CAApC;;AAEA;AACA,IAAMC,cAAc,SAAdA,WAAc,CAACC,MAAD,EAAY;AAC9B,MAAMC,QAAQC,uBAAIC,IAAJ,CACZ,EAAEC,IAAIJ,MAAN,EADY,EACIK,cAAIC,GAAJ,CAAQ,aAAR,CADJ,EAEZ,EAAEC,WAAW,KAAb,CAAoB;AAApB,GAFY,CAAd;AAIA,SAAON,KAAP;AACD,CAND;;AAQA,IAAMO,kBAAkB;AACtBd,UAAQA,OAAOe,MAAP,CAAc,WAAd,CADc,EACc;AACpCC,QAFsB,kBAEfC,GAFe,EAEVC,GAFU,EAEL;AAAA;;AAAE;AACjB;AACA,QAAI,CAACD,IAAIE,IAAJ,CAASC,QAAV,IAAsB,CAACH,IAAIE,IAAJ,CAASE,QAAhC,IAA4C,CAACJ,IAAIE,IAAJ,CAASG,KAAtD,IAA+D,CAACL,IAAIE,IAAJ,CAASI,MAA7E,EAAqF;AACnF,aAAO5B,4BAA4BuB,GAA5B,CAAP;AACD;AACD;AACA,QAAMM,iBAAiBC,mBAAOC,QAAP,CAAgBT,IAAIE,IAAJ,CAASE,QAAzB,EAAmC,CAAnC,CAAvB;;AANe,gBAQA,CAACJ,IAAIU,IAAL,CARA;AAAA,QAQRA,IARQ;;AASf,QAAIC,WAAW,EAAf;;AAEA;;AAEAtC,SAAKuC,OAAL,GAAeC,IAAf;AAAA,2EAAoB,iBAAOC,OAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AACZC,qBADY,GACJD,QAAQE,IADJ;AAEdC,yBAFc,GAEF,CAFE;AAAA;AAAA;AAAA;AAAA;AAAA,4BAGCF,KAHD;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAGPG,oBAHO;;AAAA,sBAIZlB,IAAIE,IAAJ,CAASC,QAAT,KAAsBe,KAAKf,QAJf;AAAA;AAAA;AAAA;;AAAA,iDAIgCvB,qBAAqBqB,GAArB,CAJhC;;AAAA;AAAA,sBAKZD,IAAIE,IAAJ,CAASG,KAAT,KAAmBa,KAAKb,KALZ;AAAA;AAAA;AAAA;;AAAA,iDAK0BxB,kBAAkBoB,GAAlB,CAL1B;;AAAA;AAAA,sBAMZD,IAAIE,IAAJ,CAASiB,KAAT,KAAmBD,KAAKC,KANZ;AAAA;AAAA;AAAA;;AAAA,iDAM0BrC,kBAAkBmB,GAAlB,CAN1B;;AAAA;AAOhBgB,6BAAa,CAAb;;AAPgB;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA,sBASdA,cAAcF,MAAMK,MATN;AAAA;AAAA;AAAA;;AAAA,qBAUZV,IAVY;AAAA;AAAA;AAAA;;AAWd;AACMW,yBAZQ,GAYI,0BAAiBrB,GAAjB,EAAsBb,aAAtB,CAZJ;;AAAA,qBAaVkC,SAbU;AAAA;AAAA;AAAA;;AAAA,iDAaQ1C,gBAAgBsB,GAAhB,EAAqBoB,SAArB,CAbR;;AAAA;AAAA;AAAA;AAAA,uBAeK9C,qBAAqBmC,IAArB,EAA2B,YAA3B,CAfL;;AAAA;AAeZC,wBAfY;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA,iDAiBLV,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,aAjBK;;AAAA;;AAqBhB;AACMC,oBAtBU,GAsBH;AACXC,yBAAOzB,IAAIE,IAAJ,CAASuB,KADL;AAEXC,6BAAW1B,IAAIE,IAAJ,CAASwB,SAFT;AAGXC,4BAAU3B,IAAIE,IAAJ,CAASyB,QAHR;AAIXxB,4BAAUH,IAAIE,IAAJ,CAASC,QAJR;AAKXC,4BAAUG,cALC;AAMXF,yBAAOL,IAAIE,IAAJ,CAASG,KANL;AAOXC,0BAAQN,IAAIE,IAAJ,CAASI,MAPN;AAQXsB,2BAAS5B,IAAIE,IAAJ,CAAS0B,OARP;AASXT,yBAAOnB,IAAIE,IAAJ,CAASiB,KATL;AAUXU,6BAAWlB;AAVA,iBAtBG;;;AAmChBtC,qBAAK0B,MAAL,CAAYyB,IAAZ,EAAkB;AAAlB,iBACGX,IADH,CACQ,UAACiB,MAAD,EAAY;AAChB,sBAAMZ,OAAOY,OAAOd,IAAP,CAAY,CAAZ,CAAb;AACA,sBAAM1B,QAAQF,YAAY8B,KAAKzB,EAAjB,CAAd,CAFgB,CAEoB;AACpC,sBAAIH,KAAJ,EAAW,OAAOW,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEL,UAAF,EAAQa,MAAM,IAAd,EAAoBzC,YAApB,EAArB,CAAP;AACZ,iBALH,EAKK0C,KALL,CAKW;AAAA,yBAASvD,mBAAmBwD,KAAnB,EAA0BhC,GAA1B,EAA+BU,QAA/B,CAAT;AAAA,iBALX;;AAnCgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAApB;;AAAA;AAAA;AAAA;AAAA,SA0CGqB,KA1CH,CA0CS;AAAA,aAASvD,mBAAmBwD,KAAnB,EAA0BhC,GAA1B,CAAT;AAAA,KA1CT;AA2CD,GA1DqB;AA2DtBiC,OA3DsB,iBA2DhBlC,GA3DgB,EA2DXC,GA3DW,EA2DN;AAAE;AAChB;AACA5B,SAAK8D,OAAL,CAAa,EAAEC,OAAO,EAAEjC,UAAUH,IAAIE,IAAJ,CAASC,QAArB,EAAT,EAAb,EACGU,IADH,CACQ,UAACiB,MAAD,EAAY;AAChB,UAAMZ,OAAOY,OAAOd,IAAP,CAAY,CAAZ,CAAb;AACA;AACA,UAAI,CAACE,IAAL,EAAW,OAAOjB,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEc,SAAS,2BAAX,EAArB,CAAP;AACX;AACA,UAAMC,cAAc9B,mBAAO+B,WAAP,CAAmBvC,IAAIE,IAAJ,CAASE,QAA5B,EAAsCc,KAAKd,QAA3C,CAApB;AACA,UAAI,CAACkC,WAAL,EAAkB,OAAOrC,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEc,SAAS,2BAAX,EAArB,CAAP;AAClB,UAAM/C,QAAQF,YAAY8B,KAAKzB,EAAjB,CAAd,CAPgB,CAOoB;AACpC;AACA,UAAIH,KAAJ,EAAW,OAAOW,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEL,UAAF,EAAQa,MAAM,IAAd,EAAoBzC,YAApB,EAArB,CAAP;AACZ,KAXH,EAWK0C,KAXL,CAWW;AAAA,aAAK/B,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBiB,CAArB,CAAL;AAAA,KAXX;AAYD;AAzEqB,CAAxB;;kBA4Ee3C,e","file":"users.js","sourceRoot":"/home/somto/1Projects/mentorship project/StackOverflow-lite/server/server/controllers","sourcesContent":["/*  eslint import/no-cycle: [2, { maxDepth: 1 }]  */\n/* eslint-disable no-restricted-syntax */\nimport multer from 'multer';\nimport jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\nimport models from '../models';\nimport app from '../../app';\nimport errorHandler from './utilities/errorHandler';\nimport fileFilterMethod from './utilities/fileFilter';\nimport imageStorage from './utilities/filebaseStorage';\n\nconst [User] = [models.User];\nconst [uploadImageToStorage] = [imageStorage.uploadImageToStorage];\nconst [createHandlerError] = [errorHandler.createHandlerError]; // create handleError\n// incomplete field handleError\nconst [incompleteFieldHandlerError] = [errorHandler.incompleteFieldHandlerError];\nconst [fileHandleError] = [errorHandler.fileHandleError]; // file handleError\nconst [usernameHandlerError] = [errorHandler.usernameHandlerError]; // username handleError\nconst [emailHandlerError] = [errorHandler.emailHandlerError]; // email handleError\nconst [phoneHandlerError] = [errorHandler.phoneHandlerError]; // phone handleError\n\nconst upload = multer({\n  storage: multer.memoryStorage()\n});\n\nconst fileSizeLimit = 1024 * 1024 * 2;\n\n// Token creation hanlder method\nconst tokenMethod = (userId) => {\n  const token = jwt.sign(\n    { id: userId }, app.get('superSecret'),\n    { expiresIn: 86400 }// expires in 24 hours\n  );\n  return token;\n};\n\nconst usersController = {\n  upload: upload.single('userImage'), // image upload\n  create(req, res) { // create a user\n    /* Required feilds */\n    if (!req.body.username || !req.body.password || !req.body.email || !req.body.gender) {\n      return incompleteFieldHandlerError(res);\n    }\n    // Auto-gen a salt and hash\n    const hashedPassword = bcrypt.hashSync(req.body.password, 8);\n\n    const [file] = [req.file];\n    let fileName = '';\n\n    /* Search to see if username, email and phone exist before creation\n    to avoid skipping of id on unique constraint */\n    User.findAll().then(async (results) => {\n      const users = results.rows;\n      let userCount = 0;\n      for (const user of users) {\n        if (req.body.username === user.username) return usernameHandlerError(res);\n        if (req.body.email === user.email) return emailHandlerError(res);\n        if (req.body.phone === user.phone) return phoneHandlerError(res);\n        userCount += 1;\n      }\n      if (userCount === users.length) { // Create user after checking if it exist\n        if (file) {\n          // implementing the file filter method\n          const fileError = fileFilterMethod(req, fileSizeLimit);\n          if (fileError) return fileHandleError(res, fileError);\n          try {\n            fileName = await uploadImageToStorage(file, 'userImages');\n          } catch (error) {\n            return res.status(400).send(error);\n          }\n        }\n\n        // Grab data from http request\n        const data = {\n          title: req.body.title,\n          firstname: req.body.firstname,\n          lastname: req.body.lastname,\n          username: req.body.username,\n          password: hashedPassword,\n          email: req.body.email,\n          gender: req.body.gender,\n          country: req.body.country,\n          phone: req.body.phone,\n          userImage: fileName\n        };\n\n        User.create(data) // pass data to our model\n          .then((result) => {\n            const user = result.rows[0];\n            const token = tokenMethod(user.id); // Generate token\n            if (token) return res.status(201).send({ user, auth: true, token });\n          }).catch(error => createHandlerError(error, res, fileName));\n      }\n    }).catch(error => createHandlerError(error, res));\n  },\n  check(req, res) { // login with username and password\n    // pass data to our model\n    User.findOne({ where: { username: req.body.username } })\n      .then((result) => {\n        const user = result.rows[0];\n        // Returning error message for user not found\n        if (!user) return res.status(400).send({ message: 'Invalid username/password' });\n        // Compare hash from your password DB.\n        const passIsEqual = bcrypt.compareSync(req.body.password, user.password);\n        if (!passIsEqual) return res.status(404).send({ message: 'Invalid username/password' });\n        const token = tokenMethod(user.id); // Generate token\n        // Returning user detais\n        if (token) return res.status(200).send({ user, auth: true, token });\n      }).catch(e => res.status(400).send(e));\n  },\n};\n\nexport default usersController;\n"]}
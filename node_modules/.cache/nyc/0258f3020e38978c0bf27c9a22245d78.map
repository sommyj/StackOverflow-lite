{"version":3,"sources":["users.js"],"names":["models","User","deleteFile","fsHelper","incompleteFieldHandlerError","errorHandler","fileTypeHandleError","fileSizeHandleError","usernameHandlerError","emailHandlerError","phoneHandlerError","upload","dest","fileSizeLimit","tokenMethod","userId","token","jwt","sign","id","app","get","expiresIn","usersController","single","create","req","res","fileSizeError","fileTypeError","filePath","body","username","password","email","gender","hashedPassword","bcrypt","hashSync","data","title","firstname","lastname","country","phone","userImage","findAll","then","results","users","rows","userCount","user","length","result","status","send","auth","catch","e","check","findOne","where","message","passIsEqual","compareSync"],"mappings":"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","file":"users.js","sourceRoot":"/home/somto/1Projects/mentorship project/StackOverflow-lite/server/server/controllers","sourcesContent":["/*  eslint import/no-cycle: [2, { maxDepth: 1 }]  */\n/* eslint-disable no-restricted-syntax */\nimport multer from 'multer';\nimport jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\nimport models from '../models';\nimport app from '../../app';\nimport fsHelper from '../../utilities/fileSystem';\nimport errorHandler from './utilities/errorHandler';\nimport fileFilterMethod from './utilities/fileFilter';\n\nconst [User] = [models.User];\nconst deleteFile = fsHelper.deleteFile;//Delete file helper method\n\nconst incompleteFieldHandlerError = errorHandler.incompleteFieldHandlerError //incomplete field handleError\nconst fileTypeHandleError = errorHandler.fileTypeHandleError //file type handleError\nconst fileSizeHandleError = errorHandler.fileSizeHandleError //file size handleError\nconst usernameHandlerError = errorHandler.usernameHandlerError //username handleError\nconst emailHandlerError = errorHandler.emailHandlerError //email handleError\nconst phoneHandlerError = errorHandler.phoneHandlerError //phone handleError\n\nconst upload = multer({\n  dest: './usersUploads/'\n});\n\nconst fileSizeLimit = 1024 * 1024 * 2;\n\n// Token creation hanlder method\nconst tokenMethod = (userId) => {\n  const token = jwt.sign(\n    { id: userId }, app.get('superSecret'),\n    { expiresIn: 86400 }// expires in 24 hours\n  );\n  return token;\n};\n\n// /* File filter handle method */\n// const fileFilterMethod = (req) => {\n//   const fileErrorArray = [];\n//   let fileSizeError = false, fileTypeError = false, filePath = '';\n//\n//   if (req.file) {\n//     const tempPath = `./${req.file.path}`;\n//     const targetPath = `./usersUploads/${new Date().toISOString() + req.file.originalname}`;\n//     if (req.file.mimetype === 'image/jpeg' || req.file.mimetype === 'image/png') {\n//       if (req.file.size <= fileSizeLimit) {\n//         renameFile(tempPath, targetPath);\n//         // remove the dot in targetPath\n//         filePath = targetPath.substring(1, targetPath.length);\n//       } else { deleteFile(tempPath); fileSizeError = true; }\n//     } else { deleteFile(tempPath); fileTypeError = true; }\n//   }\n//   fileErrorArray[0] = fileSizeError; fileErrorArray[1] = fileTypeError;\n//   fileErrorArray[2] = filePath;\n//\n//   return fileErrorArray;\n// };\n\n\nconst usersController = {\n  upload: upload.single('userImage'), // image upload\n  create(req, res) { // create a user\n    // implementing the file filter method\n    const [fileSizeError, fileTypeError, filePath] = fileFilterMethod(req, fileSizeLimit, 'usersUploads');\n    if (fileSizeError) return fileSizeHandleError(res);\n    if (fileTypeError) return fileTypeHandleError(res);\n    /* Required feilds */\n    if (!req.body.username || !req.body.password || !req.body.email || !req.body.gender)\n      return incompleteFieldHandlerError(res, filePath);\n    // Auto-gen a salt and hash\n    const hashedPassword = bcrypt.hashSync(req.body.password, 8);\n    // Grab data from http request\n    const data = {\n      title: req.body.title,\n      firstname: req.body.firstname,\n      lastname: req.body.lastname,\n      username: req.body.username,\n      password: hashedPassword,\n      email: req.body.email,\n      gender: req.body.gender,\n      country: req.body.country,\n      phone: req.body.phone,\n      userImage: filePath\n    };\n    /* Search to see if username, email and phone exist before creation\n    to avoid skipping of id on unique constraint */\n    User.findAll().then((results) => { const users = results.rows;\n      let userCount = 0;\n      for (const user of users) {\n        if (data.username === user.username) return usernameHandlerError(res, filePath);\n        if (data.email === user.email) return emailHandlerError(res, filePath);\n        if (data.phone === user.phone) return phoneHandlerError(res, filePath);\n        userCount += 1;\n      }\n      if (userCount === users.length) { // Create user after checking if it exist\n        User.create(data) // pass data to our model\n          .then((result) => { const user = result.rows[0];\n            const token = tokenMethod(user.id); // Generate token\n            if (token) return res.status(201).send({ user, auth: true, token });\n          }).catch(e => res.status(400).send(e));\n      }\n    }).catch(e => res.status(400).send(e));\n  },\n  check(req, res) { // login with username and password\n    // pass data to our model\n    User.findOne({ where: { username: req.body.username } })\n      .then((result) => {\n        const user = result.rows[0];\n        // Returning error message for user not found\n        if (!user) return res.status(400).send({ message: 'Invalid username/password' });\n        // Compare hash from your password DB.\n        const passIsEqual = bcrypt.compareSync(req.body.password, user.password);\n        if (!passIsEqual) return res.status(404).send({ message: 'Invalid username/password' });\n        const token = tokenMethod(user.id); // Generate token\n        // Returning user detais\n        if (token) return res.status(200).send({ user, auth: true, token });\n      }).catch(e => res.status(400).send(e));\n  },\n};\n\nexport default usersController;\n"]}